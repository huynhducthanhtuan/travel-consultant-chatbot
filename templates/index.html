<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="shortcut icon"
      href="https://cdn.jsdelivr.net/npm/twemoji@11.3.0/2/svg/1f916.svg"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <title>Chatbot Tư Vấn Du Lịch</title>
  </head>
  <body>
    <h3>🌴 Chatbot Tư Vấn Du Lịch Việt Nam</h3>
    <div id="chat"></div>

    <div id="inputRow">
      <input
        id="txt"
        placeholder="Hỏi tôi về địa điểm, lịch trình du lịch ở Việt Nam..."
      />
      <button id="send">Gửi</button>
      <button id="clear">Xóa</button>
    </div>

    <script>
      const chatElement = document.getElementById("chat");
      const txt = document.getElementById("txt");
      const send = document.getElementById("send");
      const clear = document.getElementById("clear");

      // local chat history
      let history = [];

      function appendMessage(content, who = "bot", sources = []) {
        const div = document.createElement("div");
        div.className = "msg " + (who === "user" ? "user" : "bot");
        div.innerHTML = content.replace(/\n/g, "<br>");
        chatElement.appendChild(div);

        if (sources && sources.length) {
          const s = document.createElement("div");
          s.className = "sources";
          s.textContent = "Nguồn: " + JSON.stringify(sources);
          chatElement.appendChild(s);
        }
        chatElement.scrollTop = chatElement.scrollHeight;
      }

      async function sendMessage() {
        const text = txt.value.trim();
        if (!text) return;

        appendMessage(text, "user");
        txt.value = "";

        // Append - unappend temperary message
        const loadingElement = document.createElement("div");
        loadingElement.className = "msg bot";
        loadingElement.textContent = "Đang trả lời...";
        chatElement.appendChild(loadingElement);
        chatElement.scrollTop = chatElement.scrollHeight;

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, history }),
          });
          const data = await res.json();

          chatElement.removeChild(loadingElement);

          appendMessage(
            data.reply || "Xin lỗi, lỗi server",
            "bot",
            data.sources || []
          );
          history = data.history || history;
        } catch (e) {
          appendMessage("Lỗi kết nối: " + e.message, "bot");
        }
      }

      send.addEventListener("click", sendMessage);
      txt.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      clear.addEventListener("click", () => {
        chatElement.innerHTML = "";
        history = [];
      });
    </script>
  </body>
</html>
